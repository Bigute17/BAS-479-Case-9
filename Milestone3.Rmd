---
title: "Milestone 3"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Read in the sample, load packages
```{r cars}
SAMPLE <- read.csv("9.13 C9 Random Sample v1.91.csv")
library(dplyr)
library(caret)
library(regclass)
library(missForest) 

summary(SAMPLE$LastMail)
```


Binning Pt. 1
```{r binning, echo=FALSE}


ProdCatB_Bin <- c()
for (i in 1:length(SAMPLE$ProdCatB)) {
  if (is.na(SAMPLE$ProdCatB[i])) {ProdCatB_Bin[i] <- 0} else {
   if (SAMPLE$ProdCatB[i] <= 100) {ProdCatB_Bin[i] <- 1}
   if (SAMPLE$ProdCatB[i] > 100) {ProdCatB_Bin[i] <- 2} }
}


ProdCatC_Bin <- c()
for (i in 1:length(SAMPLE$ProdCatC)) {
  if (is.na(SAMPLE$ProdCatC[i])) {ProdCatC_Bin[i] <- 0} else {
   if (SAMPLE$ProdCatC[i] <= 100) {ProdCatC_Bin[i] <- 1}
   if (SAMPLE$ProdCatC[i] > 100) {ProdCatC_Bin[i] <- 2} }
}

ProdCatB_Bin <- c()
for (i in 1:length(SAMPLE$ProdCatB)) {
  if (is.na(SAMPLE$ProdCatB[i])) {ProdCatB_Bin[i] <- 0} else {
   if (SAMPLE$ProdCatB[i] <= 100) {ProdCatB_Bin[i] <- 1}
   if (SAMPLE$ProdCatB[i] > 100) {ProdCatB_Bin[i] <- 2} }
}

ProdCatD_Bin <- c()
for (i in 1:length(SAMPLE$ProdCatD)) {
  if (is.na(SAMPLE$ProdCatD[i])) {ProdCatD_Bin[i] <- 0} else {
   if (SAMPLE$ProdCatD[i] <= 100) {ProdCatD_Bin[i] <- 1}
   if (SAMPLE$ProdCatD[i] > 100) {ProdCatD_Bin[i] <- 2} }
}


ProdCatE_Bin <- c()
for (i in 1:length(SAMPLE$ProdCatE)) {
  if (is.na(SAMPLE$ProdCatE[i])) {ProdCatE_Bin[i] <- 0} else {
   if (SAMPLE$ProdCatE[i] <= 100) {ProdCatE_Bin[i] <- 1}
   if (SAMPLE$ProdCatE[i] > 100) {ProdCatE_Bin[i] <- 2} }
}

canordersBin <- c()
for (i in 1:length(SAMPLE$canorders)) {
  if (SAMPLE$canorders[i] == 0) {canordersBin[i] <- 0} else {
   canordersBin[i] <- 1 }
}

webuseBin <- c()
for (i in 1:length(SAMPLE$WebUse)) {
  if (SAMPLE$WebUse[i] == 0 | is.na(SAMPLE$WebUse[i])) {webuseBin[i] <- 0} else {
   webuseBin[i] <- 1 }
}

SAMPLE <- cbind(SAMPLE, ProdCatB_Bin, ProdCatC_Bin, ProdCatD_Bin, ProdCatE_Bin, canordersBin, webuseBin)

SAMPLE <- subset(SAMPLE, select = -c(ProdCatB, ProdCatC, ProdCatD, ProdCatE, WebUse, canorders) )
```

Binning pt.2
```{r}
LastMailBins <- c()
for (i in 1:length(SAMPLE$LastMail)) {
  if (is.na(SAMPLE$LastMail[i])) {LastMailBins[i] <- 6} else {
   if (SAMPLE$LastMail[i] <= 6) {LastMailBins[i] <- 1}
   if (SAMPLE$LastMail[i] <= 12) {LastMailBins[i] <- 2}
     if (SAMPLE$LastMail[i] <= 18) {LastMailBins[i] <- 3} 
     if (SAMPLE$LastMail[i] <= 24) {LastMailBins[i] <- 4} 
     if (SAMPLE$LastMail[i] <= 30) {LastMailBins[i] <- 5} }
}

monthfrstordbin <- c()
for (i in 1:length(SAMPLE$monthfrstord)) {
  if (is.na(SAMPLE$monthfrstord[i])) {monthfrstordbin[i] <- 6} else {
   if (SAMPLE$monthfrstord[i] <= 6) {monthfrstordbin[i] <- 1}
   if (SAMPLE$monthfrstord[i] <= 12) {monthfrstordbin[i] <- 2}
     if (SAMPLE$monthfrstord[i] <= 18) {monthfrstordbin[i] <- 3} 
     if (SAMPLE$monthfrstord[i] <= 24) {monthfrstordbin[i] <- 4} 
     if (SAMPLE$monthfrstord[i] <= 30) {monthfrstordbin[i] <- 5} }
}

monthlastordbin <- c()
for (i in 1:length(SAMPLE$monthlastord)) {
  if (is.na(SAMPLE$monthlastord[i])) {monthlastordbin[i] <- 6} else {
   if (SAMPLE$monthlastord[i] <= 6) {monthlastordbin[i] <- 1}
   if (SAMPLE$monthlastord[i] <= 12) {monthlastordbin[i] <- 2}
     if (SAMPLE$monthlastord[i] <= 18) {monthlastordbin[i] <- 3} 
     if (SAMPLE$monthlastord[i] <= 24) {monthlastordbin[i] <- 4} 
     if (SAMPLE$monthlastord[i] <= 30) {monthlastordbin[i] <- 5} }
}

SAMPLE <- cbind(SAMPLE, LastMailBins, monthfrstordbin, monthlastordbin)

SAMPLE <- subset(SAMPLE, select = -c(LastMail, monthfrstord, monthlastord) )

SAMPLE <- subset(SAMPLE, select = -c(Demo, offdolr_12, offord_24, Oth1Dolr, Oth2Dolr, Oth3Dolr, Oth4Dolr, PurcPower, TotPurch, webdolr) )
```

Exclude Rows With Outliers
```{r}
RowsWithOutliers <- SAMPLE[c(1:48, 20069, 10031, 56477, 21624, 28370, 12476, 53592, 76806, 63697, 93039, 92680, 44048, 41182),]


SAMPLE2.1 <- SAMPLE[-c(1:48, 20069, 10031, 56477, 21624, 28370, 12476, 53592, 76806, 63697, 93039, 92680, 44048, 41182),]
```

Random Forest Imputation for Age
```{r}

SAMPLE.MISSFORESTTEST <- data.frame(SAMPLE2.1$Age,SAMPLE2.1$Age1,SAMPLE2.1$Age2,SAMPLE2.1$Age3)
set.seed(178); SAMPLE.MISSFOREST <- missForest(SAMPLE.MISSFORESTTEST)

newdata <- SAMPLE.MISSFOREST$ximp

SAMPLE2.1$FinalAge <- newdata$SAMPLE2.1.Age
SAMPLE2.1$FinalAge <- as.integer(SAMPLE2.1$FinalAge)

```

Split the data into training and holdout samples (80/20 split)
```{r}
train.rows <- sample
```


Logistic Regression Model
```{r}

```

Decision Tree Model
```{r}

```

```{r}

library(caret)
library(gbm)
library(pROC)
data("SAMPLE")

for(i in 1:length(SAMPLE2.1$Resp)){
  
  if(SAMPLE2.1$Resp[i] == 0){SAMPLE2.1$Resp[i] <- "No"}
  else
    if(SAMPLE2.1$Resp[i] == 1) {SAMPLE2.1$Resp[i] <- "Yes"}
}

SAMPLE2.1$Resp <- as.factor(SAMPLE2.1$Resp)
train.rows <- sample(nrow(SAMPLE),20000)
TRAIN <- SAMPLE[train.rows,]
HOLDOUT <- SAMPLE[-train.rows,]

fitcontrol <- trainControl(method="cv", number = 5, classProbs=TRUE, summaryFunction = twoClassSummary)
summary(fitcontrol)

LRM <- train(Resp~.,data=TRAIN,method="glm",
               trcontrol=fitcontrol)

LRM$results[rownames(LRM$bestTune),]

mean(PURCHASE_HOLDOUT$Purchase == predict(LRM,newdata=PURCHASE_HOLDOUT) )

roc(PURCHASE_HOLDOUT$Purchase,predict(LRM,newdata=PURCHASE_HOLDOUT,type="prob")[,2])  

varImp(LRM)
plot(varImp(LRM), top =10, xlim = c(0,100), main = "Variable Importance for LRM")

BEST.PARAMS.2$LRM <- LRM$results[rownames(LRM$bestTune),]

BEST.PARAMS.2$LRM <- LRM$results[rownames(LRM$bestTune),][,2]
BEST.PARAMS.2H$LRM <- 0.625  
BEST.PARAMS.2SD$LRM <- LRM$results[rownames(LRM$bestTune),][,5]
BEST.PARAMS.2Sensitivity$LRM <- LRM$results[rownames(LRM$bestTune),][,3]
BEST.PARAMS.2SSpecificity$LRM <- LRM$results[rownames(LRM$bestTune),][,4]
```

